# 장애 대응 가이드

## 1. 개요

### 1.1 문서 목적

본 문서는 HH E-Commerce 시스템에서 발생할 수 있는 장애 상황에 대한 대응 절차와 가이드라인을 정의합니다.

### 1.2 장애 정의

| 구분 | 정의 | 예시 |
|------|------|------|
| **장애 (Incident)** | 서비스 정상 운영을 방해하는 예상치 못한 상황 | API 응답 불가, 데이터 손실 |
| **오류 (Error)** | 개별 요청의 실패로 서비스 전체에 영향 없음 | 개별 주문 실패, 쿠폰 발급 실패 |
| **경고 (Warning)** | 잠재적 문제 징후로 모니터링 필요 | 응답시간 증가, 에러율 상승 |

---

## 2. 장애 등급 분류

### 2.1 등급 기준

| 등급 | 영향도 | 기준 | 대응 시간 |
|------|--------|------|----------|
| **P1 (Critical)** | 전체 서비스 중단 | 모든 API 응답 불가 | 즉시 |
| **P2 (Major)** | 핵심 기능 장애 | 주문/결제 불가 | 30분 이내 |
| **P3 (Minor)** | 부분 기능 장애 | 특정 API 오류 증가 | 2시간 이내 |
| **P4 (Low)** | 경미한 영향 | 성능 저하 | 다음 업무일 |

### 2.2 장애 판단 기준

```
┌─────────────────────────────────────────────────────────────────┐
│                        장애 판단 기준                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   P1 (Critical)                                                 │
│   ├── API 서버 응답 없음 (5분 이상)                              │
│   ├── DB 연결 불가                                              │
│   └── 전체 에러율 > 50%                                         │
│                                                                 │
│   P2 (Major)                                                    │
│   ├── 주문 생성 API 에러율 > 30%                                │
│   ├── 결제 처리 실패율 > 20%                                    │
│   └── 쿠폰 발급 동시성 오류 (초과 발급)                          │
│                                                                 │
│   P3 (Minor)                                                    │
│   ├── 특정 API p95 응답시간 > 5초                               │
│   ├── Redis 연결 오류 발생                                      │
│   └── Kafka Consumer Lag > 10,000                              │
│                                                                 │
│   P4 (Low)                                                      │
│   ├── 캐시 히트율 저하 (< 70%)                                  │
│   └── 응답시간 평소 대비 50% 증가                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 장애 대응 프로세스

### 3.1 대응 단계

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  탐지   │ →  │  분류   │ →  │  대응   │ →  │  복구   │ →  │  회고   │
│Detection│    │Classify │    │Response │    │Recovery │    │Retrospect│
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
    │              │              │              │              │
    ▼              ▼              ▼              ▼              ▼
  모니터링      등급 판단      원인 분석      서비스 정상화    문서화
  알람 수신    담당자 배정    임시 조치      모니터링 확인    개선안 도출
```

### 3.2 단계별 상세

#### Step 1: 탐지 (Detection)

| 탐지 방법 | 설명 | 도구 |
|----------|------|------|
| 자동 알람 | 임계치 초과 시 자동 알림 | Prometheus + Grafana |
| 헬스체크 | API 생존 여부 주기적 확인 | Spring Actuator |
| 로그 모니터링 | 에러 로그 실시간 분석 | OpenSearch |
| 사용자 신고 | 고객 문의를 통한 탐지 | CS 채널 |

#### Step 2: 분류 (Classify)

**체크리스트:**
- [ ] 영향 범위 확인 (전체/부분)
- [ ] 장애 등급 판단 (P1~P4)
- [ ] 담당자 연락 및 배정
- [ ] 이해관계자 알림

#### Step 3: 대응 (Response)

**즉시 조치:**
1. 장애 현상 캡처 (로그, 메트릭, 스크린샷)
2. 영향도 분석 및 공유
3. 임시 우회 방안 적용
4. 근본 원인 분석 시작

#### Step 4: 복구 (Recovery)

**복구 확인 체크리스트:**
- [ ] 에러율 정상 수준 복귀
- [ ] 응답시간 정상 범위 내
- [ ] 비즈니스 메트릭 정상 (주문 수, 결제 성공률)
- [ ] 백로그 처리 완료 (Kafka Lag 등)

#### Step 5: 회고 (Retrospective)

**회고 문서 작성 (장애 발생 후 48시간 이내)**

---

## 4. 가상 장애 시나리오

### 4.1 시나리오 1: 주문 폭주로 인한 DB 커넥션 고갈

**상황:**
```
- 타임세일 시작 직후 주문 요청 10배 급증
- DB 커넥션 풀 고갈
- 주문 API 타임아웃 증가
- 에러율 30% 이상
```

**탐지:**
- Grafana 알람: `hikaricp_connections_active > 90%`
- 로그: `HikariPool-1 - Connection is not available, request timed out`

**분류:**
- 등급: P2 (Major)
- 영향: 주문 생성 불가

**대응:**
1. **즉시 조치 (5분 이내)**
   ```bash
   # 현재 커넥션 상태 확인
   curl http://localhost:8080/actuator/metrics/hikaricp.connections.active

   # 불필요한 커넥션 정리
   mysql -e "SHOW PROCESSLIST" | grep Sleep | awk '{print $1}' | xargs -I {} mysql -e "KILL {}"
   ```

2. **임시 완화**
   - 캐시 TTL 연장으로 DB 부하 감소
   - Rate Limiting 적용

3. **근본 해결**
   ```yaml
   # application.yml
   spring:
     datasource:
       hikari:
         maximum-pool-size: 50   # 기존 20 → 50
         minimum-idle: 10
         connection-timeout: 3000
   ```

**복구 확인:**
- 커넥션 사용률 < 70%
- 주문 API 에러율 < 1%

**회고 포인트:**
- 커넥션 풀 사이즈 적정성 검토
- 커넥션 누수 여부 확인
- 오토스케일링 도입 검토

---

### 4.2 시나리오 2: 쿠폰 초과 발급 (동시성 오류)

**상황:**
```
- 선착순 100개 쿠폰 이벤트
- 200개 이상 발급되는 현상 발생
- 고객 클레임 접수
```

**탐지:**
- 비즈니스 모니터링: 발급 수 > 총 수량
- 로그: 동시성 제어 실패 로그

**분류:**
- 등급: P2 (Major)
- 영향: 비용 손실, 고객 신뢰도 하락

**대응:**
1. **즉시 조치**
   ```bash
   # 쿠폰 발급 API 임시 중단
   # Feature Flag 또는 설정 변경

   # Redis에서 발급 현황 확인
   redis-cli HGETALL "coupon:issue:count"
   ```

2. **피해 최소화**
   - 초과 발급된 쿠폰 사용 불가 처리
   - 영향받은 고객에게 안내 및 보상

3. **근본 해결**
   ```java
   // Redis Lua Script로 원자적 처리 보장
   String luaScript = """
       local issued = redis.call('HINCRBY', KEYS[1], 'issued', 1)
       if issued > tonumber(ARGV[1]) then
           redis.call('HINCRBY', KEYS[1], 'issued', -1)
           return 0
       end
       return 1
   """;
   ```

**복구 확인:**
- 발급 수 = 총 수량 정확히 일치
- 동시성 테스트 통과

**회고 포인트:**
- 동시성 테스트 케이스 추가
- Redis Lua Script 검증 강화
- 모니터링 알람 추가 (발급수 > 90% 시 알람)

---

### 4.3 시나리오 3: Kafka Consumer 지연

**상황:**
```
- 주문 완료 이벤트 처리 지연
- 외부 시스템 데이터 동기화 지연
- Kafka Consumer Lag 급증 (> 100,000)
```

**탐지:**
- Kafka UI: Consumer Lag 급증
- 알람: `kafka_consumer_lag > 10000`

**분류:**
- 등급: P3 (Minor)
- 영향: 데이터 동기화 지연 (서비스 영향 없음)

**대응:**
1. **상황 파악**
   ```bash
   # Consumer Lag 확인
   kafka-consumer-groups --bootstrap-server localhost:9092 \
     --describe --group order-event-group

   # 처리량 확인
   kafka-run-class kafka.tools.GetOffsetShell \
     --broker-list localhost:9092 --topic order.completed
   ```

2. **임시 조치**
   - Consumer 인스턴스 추가
   - 파티션 재할당

3. **근본 해결**
   ```yaml
   # Consumer 설정 튜닝
   spring:
     kafka:
       consumer:
         max-poll-records: 500      # 배치 크기 증가
         fetch-max-wait: 500ms
       listener:
         concurrency: 5             # 병렬 처리
   ```

**복구 확인:**
- Consumer Lag < 1,000
- 처리 지연 시간 < 1분

---

### 4.4 시나리오 4: Redis 메모리 부족

**상황:**
```
- Redis 메모리 사용률 > 90%
- 캐시 저장 실패
- OOM (Out of Memory) 발생 위험
```

**탐지:**
- 알람: `redis_memory_used_bytes > 90%`
- 로그: `OOM command not allowed`

**분류:**
- 등급: P2 (Major)
- 영향: 캐시 기능 장애, 분산 락 실패 가능

**대응:**
1. **즉시 조치**
   ```bash
   # 메모리 사용 현황
   redis-cli INFO memory

   # 큰 키 확인
   redis-cli --bigkeys

   # 만료 키 강제 삭제
   redis-cli SCAN 0 COUNT 1000 | xargs redis-cli DEL
   ```

2. **임시 완화**
   - TTL이 긴 캐시 수동 삭제
   - 메모리 정책 조정 (allkeys-lru)

3. **근본 해결**
   ```bash
   # Redis 메모리 증설 또는 클러스터 확장
   # maxmemory 설정 조정
   redis-cli CONFIG SET maxmemory 2gb
   redis-cli CONFIG SET maxmemory-policy allkeys-lru
   ```

---

## 5. 장애 회고 템플릿

### 5.1 회고 문서 양식

```markdown
# 장애 회고 보고서

## 기본 정보

| 항목 | 내용 |
|------|------|
| 장애 ID | INC-2025-001 |
| 발생 일시 | 2025-XX-XX 00:00 |
| 복구 일시 | 2025-XX-XX 00:00 |
| 장애 등급 | P2 (Major) |
| 담당자 | OOO |

## 타임라인

| 시각 | 이벤트 |
|------|--------|
| 00:00 | 장애 탐지 (알람 수신) |
| 00:05 | 담당자 확인 시작 |
| 00:15 | 원인 파악 |
| 00:30 | 임시 조치 적용 |
| 01:00 | 서비스 복구 확인 |

## 영향도

- 영향 받은 사용자 수: XXX명
- 실패한 요청 수: XXX건
- 비즈니스 손실: XXX원 (추정)

## 근본 원인

[상세 기술 분석]

## 조치 내역

1. 즉시 조치: ...
2. 임시 완화: ...
3. 근본 해결: ...

## 재발 방지 대책

| 조치 | 담당자 | 기한 | 상태 |
|------|--------|------|------|
| 모니터링 강화 | OOO | 2025-XX-XX | 진행중 |
| 코드 수정 | OOO | 2025-XX-XX | 완료 |

## 교훈

### 잘한 점
- ...

### 개선할 점
- ...

## 참고 자료

- 로그 파일: ...
- 대시보드 스크린샷: ...
```

---

## 6. 연락망 및 에스컬레이션

### 6.1 연락망

| 역할 | 담당 | 연락처 | 비고 |
|------|------|--------|------|
| 1차 대응 | 온콜 담당자 | - | 주간 로테이션 |
| 2차 에스컬레이션 | 테크리드 | - | P1, P2 즉시 연락 |
| 3차 에스컬레이션 | 엔지니어링 매니저 | - | P1 시 연락 |

### 6.2 에스컬레이션 기준

| 조건 | 에스컬레이션 대상 |
|------|------------------|
| 30분 이내 복구 불가 | 테크리드 |
| P1 장애 발생 | 테크리드 + 엔지니어링 매니저 |
| 데이터 손실 가능성 | 모든 관계자 |

---

## 7. 체크리스트

### 7.1 장애 발생 시 체크리스트

- [ ] 장애 현상 캡처 (로그, 메트릭, 스크린샷)
- [ ] 영향 범위 파악
- [ ] 장애 등급 결정
- [ ] 담당자 및 이해관계자 알림
- [ ] 타임라인 기록 시작
- [ ] 원인 분석 시작
- [ ] 임시 조치 적용
- [ ] 복구 확인
- [ ] 회고 문서 작성 예약

### 7.2 복구 후 체크리스트

- [ ] 서비스 정상 동작 확인
- [ ] 비즈니스 메트릭 정상 확인
- [ ] 백로그 처리 완료 확인
- [ ] 이해관계자에게 복구 알림
- [ ] 회고 일정 확정
- [ ] 회고 문서 작성
- [ ] 재발 방지 대책 수립
