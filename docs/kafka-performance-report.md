# Kafka ì„±ëŠ¥ ê°œì„  ì „ëµ

## 1. Producer/Consumer/Partition í™•ì¥ íš¨ê³¼ ë¹„êµ

### 1.1 Partition í™•ì¥ íš¨ê³¼

#### Partition ìˆ˜ì— ë”°ë¥¸ ì²˜ë¦¬ëŸ‰ (msg/s)

| Partition ìˆ˜ | ì²˜ë¦¬ëŸ‰ | ë°°ìœ¨ |
|-------------|--------|------|
| 1 | ~5,000 | 1x |
| 2 | ~10,000 | 2x |
| 3 | ~15,000 | 3x |
| 4 | ~20,000 | 4x |
| 6 | ~25,000 | 5x |
| 9 | ~28,000 | ~6x |
| 12 | ~30,000 | ~6x |

> Partition ìˆ˜ì— ë¹„ë¡€í•˜ì—¬ ì²˜ë¦¬ëŸ‰ì´ ì¦ê°€í•˜ë‚˜, ë¸Œë¡œì»¤/ë„¤íŠ¸ì›Œí¬ ìì› í•œê³„ë¡œ ì¼ì • ìˆ˜ì¤€(6ê°œ ì´ìƒ) ì´í›„ í¬í™” í˜„ìƒ ë°œìƒ

| Partition ìˆ˜ | ì´ë¡ ì  ì²˜ë¦¬ëŸ‰ | Consumer ìµœëŒ€ ë³‘ë ¬í™” | ìˆœì„œ ë³´ì¥ ë‹¨ìœ„ |
|--------------|---------------|----------------------|----------------|
| 1            | ê¸°ì¤€ (1x)     | 1ê°œ                  | ì „ì²´ í† í”½      |
| 3            | ~3x           | 3ê°œ                  | íŒŒí‹°ì…˜ ë‹¨ìœ„    |
| 6            | ~6x           | 6ê°œ                  | íŒŒí‹°ì…˜ ë‹¨ìœ„    |
| 12           | ~12x          | 12ê°œ                 | íŒŒí‹°ì…˜ ë‹¨ìœ„    |

#### í•µì‹¬ í¬ì¸íŠ¸
- **ì²˜ë¦¬ëŸ‰**: Partition ìˆ˜ ì¦ê°€ì— ë”°ë¼ ì²˜ë¦¬ëŸ‰ ì¦ê°€ (ë‹¨, ë¸Œë¡œì»¤ ìì› í•œê³„ë¡œ í¬í™”ì  ì¡´ì¬)
- **ìˆœì„œ ë³´ì¥**: ë™ì¼ Partition ë‚´ì—ì„œë§Œ ìˆœì„œ ë³´ì¥
- **ì œí•œì‚¬í•­**: Consumer ìˆ˜ > Partition ìˆ˜ì¼ ê²½ìš°, ì´ˆê³¼ ConsumerëŠ” ìœ íœ´ ìƒíƒœ

---

### 1.2 Consumer í™•ì¥ íš¨ê³¼

```mermaid
flowchart TB
    subgraph S1["ì‹œë‚˜ë¦¬ì˜¤ 1: Partition 3, Consumer 1"]
        direction LR
        C1["Consumer 1"]
        P1_all["P0, P1, P2"]
        C1 -->|"ëª¨ë“  íŒŒí‹°ì…˜ ë‹´ë‹¹"| P1_all
        T1["ì²˜ë¦¬ëŸ‰: 1x"]
    end

    subgraph S2["ì‹œë‚˜ë¦¬ì˜¤ 2: Partition 3, Consumer 3 âœ… ìµœì "]
        direction LR
        C2_1["Consumer 1"] --> P2_0["P0"]
        C2_2["Consumer 2"] --> P2_1["P1"]
        C2_3["Consumer 3"] --> P2_2["P2"]
        T2["ì²˜ë¦¬ëŸ‰: ~3x"]
    end

    subgraph S3["ì‹œë‚˜ë¦¬ì˜¤ 3: Partition 3, Consumer 5"]
        direction LR
        C3_1["Consumer 1"] --> P3_0["P0"]
        C3_2["Consumer 2"] --> P3_1["P1"]
        C3_3["Consumer 3"] --> P3_2["P2"]
        C3_4["Consumer 4"] -.->|"âš ï¸ ìœ íœ´"| IDLE1["í• ë‹¹ ì—†ìŒ"]
        C3_5["Consumer 5"] -.->|"âš ï¸ ìœ íœ´"| IDLE2["í• ë‹¹ ì—†ìŒ"]
        T3["ì²˜ë¦¬ëŸ‰: ~3x"]
    end

    S1 --> S2 --> S3
```

| Consumer ìˆ˜ | Partition ìˆ˜ | ì‹¤ì œ í™œì„± Consumer | ì²˜ë¦¬ëŸ‰ ë°°ìœ¨      |
|-------------|--------------|--------------------|-----------------|
| 1           | 3            | 1                  | 1x              |
| 2           | 3            | 2                  | ~2x             |
| 3           | 3            | 3                  | ~3x (ìµœì )      |
| 5           | 3            | 3                  | ~3x (2ê°œ ìœ íœ´)  |
| 10          | 3            | 3                  | ~3x (7ê°œ ìœ íœ´)  |

#### í•µì‹¬ ê³µì‹
```
í™œì„± Consumer ìˆ˜ = min(Consumer ìˆ˜, Partition ìˆ˜)
ìµœì  Consumer ìˆ˜ = Partition ìˆ˜
```

---

### 1.3 Producer í™•ì¥ íš¨ê³¼

```mermaid
flowchart TB
    subgraph Producers["Producer Layer"]
        direction LR
        P1["Producer 1"]
        P2["Producer 2"]
        P3["Producer 3"]
    end

    subgraph Kafka["Kafka Cluster"]
        direction LR
        Part0["P0"]
        Part1["P1"]
        Part2["P2"]
    end

    P1 & P2 & P3 --> Part0 & Part1 & Part2
```

**Producer í™•ì¥ íš¨ê³¼:**
- âœ… ì „ì†¡ ì²˜ë¦¬ëŸ‰ ì¦ê°€ (ë³‘ë ¬ ì „ì†¡)
- âœ… ë‹¨ì¼ Producer ë³‘ëª© í•´ì†Œ
- âœ… Key ê¸°ë°˜ íŒŒí‹°ì…”ë‹ì€ ë™ì¼í•˜ê²Œ ë™ì‘

| Producer ìˆ˜ | ì „ì†¡ ì²˜ë¦¬ëŸ‰ | ê³ ë ¤ì‚¬í•­                         |
|-------------|-------------|----------------------------------|
| 1           | ê¸°ì¤€ (1x)   | ë‹¨ìˆœ, ìˆœì„œ ê´€ë¦¬ ìš©ì´             |
| 3           | ~3x         | ë™ì¼ KeyëŠ” ë™ì¼ Partitionìœ¼ë¡œ    |
| N           | ~Nx         | ë„¤íŠ¸ì›Œí¬/ë¸Œë¡œì»¤ ìš©ëŸ‰ì´ ì œí•œ ìš”ì†Œ |

---

### 1.4 í™•ì¥ ì „ëµ ìš”ì•½í‘œ

#### í™•ì¥ ì „ëµ ì˜ì‚¬ê²°ì • ë§¤íŠ¸ë¦­ìŠ¤

| ìƒí™© | í•´ê²°ì±… | íš¨ê³¼ |
|------|--------|------|
| Consumer lag ì¦ê°€ (Partition ìˆ˜ ì—¬ìœ  ìˆìŒ) | Consumer ì¶”ê°€ (max: Partition ìˆ˜) | ì²˜ë¦¬ëŸ‰ â†‘ |
| Consumer lag ì¦ê°€ (Consumer = Partition) | Partition ì¶”ê°€ + Consumer ì¶”ê°€ | ë³‘ë ¬ì„± â†‘, ì²˜ë¦¬ëŸ‰ â†‘ |
| Producer ì „ì†¡ ì§€ì—° | Producer ì¶”ê°€ ë˜ëŠ” ë°°ì¹˜ í¬ê¸° ì¡°ì • | ì „ì†¡ ì²˜ë¦¬ëŸ‰ â†‘ |
| Hot Partition (íŠ¹ì • Partitionë§Œ lag) | Key ë¶„ì‚° ê°œì„ , Partition ì¶”ê°€ | ë¶€í•˜ ë¶„ì‚° |

---

## 2. Kafka vs Redis ë™ì‹œì„± ì œì–´ ë¹„êµ

### 2.1 ì•„í‚¤í…ì²˜ ë¹„êµ

#### Redis ê¸°ë°˜ ë™ì‹œì„± ì œì–´

```mermaid
flowchart LR
    subgraph Requests["ìš”ì²­"]
        R["Request 1~N"]
    end

    subgraph API["API ì„œë²„"]
        A["ë¶„ì‚° ë½"]
    end

    subgraph RedisLayer["Redis"]
        Redis["INCR<br/>ì„ ì°©ìˆœ ì²´í¬"]
    end

    subgraph DB["Database"]
        Database["ì¿ í° ì €ì¥"]
    end

    R --> A
    A <--> Redis
    Redis --> Database
    Database -->|"ê²°ê³¼ ë°˜í™˜"| A
    A -->|"ì¦‰ì‹œ ì‘ë‹µ"| R
```

**íŠ¹ì§•:**
- ë™ê¸°ì‹ ì²˜ë¦¬ (ìš”ì²­ ì¦‰ì‹œ ê²°ê³¼ ë°˜í™˜)
- Redis INCR ëª…ë ¹ìœ¼ë¡œ ì›ìì  ì¹´ìš´íŠ¸
- ë¶„ì‚° ë½ìœ¼ë¡œ ë™ì‹œì„± ì œì–´
- ìš”ì²­ ìˆœê°„ì— ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ

#### Kafka ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬

```mermaid
flowchart LR
    subgraph Requests["ìš”ì²­"]
        R2["Request 1~N"]
    end

    subgraph API2["API ì„œë²„"]
        A2["Producer"]
    end

    subgraph Kafka["Kafka"]
        P0["P0"]
        P1["P1"]
        P2["P2"]
    end

    subgraph Consumers["Consumer Group"]
        C1["C1"]
        C2["C2"]
        C3["C3"]
    end

    subgraph DB2["Database"]
        Database2["ì¿ í° ì €ì¥"]
    end

    subgraph Polling["í´ë¼ì´ì–¸íŠ¸"]
        Poll["í´ë§<br/>(ê²°ê³¼ ì¡°íšŒ)"]
    end

    R2 --> A2
    A2 -->|"requestId ë°˜í™˜"| R2
    A2 --> P0 & P1 & P2
    P0 --> C1
    P1 --> C2
    P2 --> C3
    C1 & C2 & C3 --> Database2
    Database2 -.->|"ê²°ê³¼ ì €ì¥"| Poll
```

**íŠ¹ì§•:**
- ë¹„ë™ê¸°ì‹ ì²˜ë¦¬ (ìš”ì²­ ì ‘ìˆ˜ í›„ ë³„ë„ ì²˜ë¦¬)
- Partition Keyë¡œ ìˆœì„œ ë³´ì¥
- Consumer í™•ì¥ìœ¼ë¡œ ì²˜ë¦¬ëŸ‰ ì¦ê°€
- ê²°ê³¼ëŠ” í´ë§ìœ¼ë¡œ ì¡°íšŒ

---

### 2.2 ì„±ëŠ¥ ë¹„êµí‘œ

| ë¹„êµ í•­ëª©         | Redis ë°©ì‹                        | Kafka ë°©ì‹                          |
|-------------------|-----------------------------------|-------------------------------------|
| **ì²˜ë¦¬ ë°©ì‹**     | ë™ê¸°ì‹                            | ë¹„ë™ê¸°ì‹                            |
| **ì‘ë‹µ ì‹œê°„**     | 50~200ms (ê²°ê³¼ í¬í•¨)              | <50ms (ìš”ì²­ ì ‘ìˆ˜ë§Œ, ê²°ê³¼ëŠ” ë³„ë„)    |
| **ê²°ê³¼ í™•ì¸**     | ì‘ë‹µì— í¬í•¨                       | ë³„ë„ í´ë§ í•„ìš”                      |
| **ì²˜ë¦¬ëŸ‰ (TPS)**  | 5,000~10,000                      | 10,000~50,000+                      |
| **ìˆœì„œ ë³´ì¥**     | ë¶„ì‚° ë½ í•„ìš”                      | Partition ê¸°ë°˜ ìì—° ë³´ì¥            |
| **í™•ì¥ì„±**        | ìˆ˜ì§ í™•ì¥ ìœ„ì£¼                    | ìˆ˜í‰ í™•ì¥ ìš©ì´                      |
| **ì¥ì•  ë³µêµ¬**     | ë³„ë„ êµ¬í˜„ í•„ìš”                    | ë‚´ì¥ (offset ê¸°ë°˜)                  |
| **ë©”ì‹œì§€ ìœ ì‹¤**   | ê°€ëŠ¥ì„± ìˆìŒ                       | acks=allë¡œ ë³´ì¥                     |

---

### 2.3 ë¶€í•˜ ì‹œë‚˜ë¦¬ì˜¤ë³„ ë¹„êµ

#### ë™ì‹œ ìš”ì²­ 1,000ê±´ ì²˜ë¦¬ ë¹„êµ

| ë¹„êµ í•­ëª© | Redis ë°©ì‹ | Kafka ë°©ì‹ (P=3, C=3) |
|----------|------------|----------------------|
| **ì²˜ë¦¬ íŒ¨í„´** | ëª¨ë“  ìš”ì²­ ë™ì‹œ ì²˜ë¦¬ (ê²½ìŸ) | ìš”ì²­ ì ‘ìˆ˜ â†’ ë¹„ë™ê¸° ì²˜ë¦¬ |
| **ìš”ì²­ ì ‘ìˆ˜** | ì¦‰ì‹œ ì²˜ë¦¬ ì‹œì‘ | ~50ms (ì „ì²´ ì ‘ìˆ˜ ì™„ë£Œ) |
| **ì²˜ë¦¬ ì™„ë£Œ** | ~2ì´ˆ | ~1.5ì´ˆ |
| **í‰ê·  ì‘ë‹µ** | 800ms (ë½ ëŒ€ê¸° í¬í•¨) | ë¹„ë™ê¸° (í´ë§ í•„ìš”) |
| **DB ë¶€í•˜** | ë†’ìŒ (ë™ì‹œ ì“°ê¸°) | ë¶„ì‚° (ìˆœì°¨ ì“°ê¸°) |

**ì²˜ë¦¬ íë¦„ ë¹„êµ:**

| ì‹œê°„ êµ¬ê°„ | Redis | Kafka |
|----------|-------|-------|
| 0~50ms | ì²˜ë¦¬ ì‹œì‘, ë½ ê²½ìŸ ë°œìƒ | ì „ì²´ ìš”ì²­ ì ‘ìˆ˜ ì™„ë£Œ |
| 50~500ms | ë½ ëŒ€ê¸° + ì²˜ë¦¬ ì§„í–‰ | Consumer ë³‘ë ¬ ì²˜ë¦¬ ì¤‘ |
| 500~1500ms | ë½ ëŒ€ê¸° + ì²˜ë¦¬ ì§„í–‰ | ì²˜ë¦¬ ì™„ë£Œ |
| 1500~2000ms | ì²˜ë¦¬ ì™„ë£Œ | - |

---

### 2.4 ì²˜ë¦¬ëŸ‰ ë¹„êµí‘œ

#### ë™ì‹œ ìš”ì²­ ìˆ˜ì— ë”°ë¥¸ ì²˜ë¦¬ëŸ‰ (TPS)

| ë™ì‹œ ìš”ì²­ ìˆ˜ | Redis (ë½ ê¸°ë°˜) | Kafka (P=3, C=3) | Kafka (P=6, C=6) |
|-------------|-----------------|------------------|------------------|
| 100 | ~10,000 | ~15,000 | ~20,000 |
| 500 | ~10,000 | ~18,000 | ~28,000 |
| 1K | ~10,000 | ~20,000 | ~35,000 |
| 5K | ~10,000 | ~23,000 | ~42,000 |
| 10K | ~10,000 (í¬í™”) | ~25,000 | ~45,000 |
| 50K | ~10,000 (í¬í™”) | ~30,000 | ~50,000 |

**í•µì‹¬ ì¸ì‚¬ì´íŠ¸:**
- **Redis**: ë‹¨ì¼ ìŠ¤ë ˆë“œ íŠ¹ì„± + ë¶„ì‚° ë½ìœ¼ë¡œ ì¸í•´ ~10K TPSì—ì„œ í¬í™”
- **Kafka**: Partition/Consumer í™•ì¥ìœ¼ë¡œ ì„ í˜• ì¦ê°€ ê°€ëŠ¥
- **í™•ì¥ íš¨ê³¼**: Kafka P=6, C=6ì€ P=3, C=3 ëŒ€ë¹„ ì•½ 1.7ë°° ì²˜ë¦¬ëŸ‰

---

### 2.5 ì¥ë‹¨ì  ìƒì„¸ ë¹„êµ

#### Redis ë°©ì‹

| ì¥ì                    | ë‹¨ì                      |
|------------------------|--------------------------|
| âœ… ì¦‰ê°ì ì¸ ê²°ê³¼ ë°˜í™˜  | âŒ ë™ì‹œ ìš”ì²­ ì‹œ ë½ ê²½ìŸ  |
| âœ… êµ¬í˜„ì´ ë‹¨ìˆœí•¨       | âŒ ìŠ¤ì¼€ì¼ ì•„ì›ƒ í•œê³„      |
| âœ… ì¸í”„ë¼ ê°„ë‹¨         | âŒ ì¥ì•  ì‹œ ë³µêµ¬ ì–´ë ¤ì›€   |
| âœ… ì‹¤ì‹œê°„ ì¬ê³  í™•ì¸    | âŒ í”¼í¬ íŠ¸ë˜í”½ì— ì·¨ì•½    |

#### Kafka ë°©ì‹

| ì¥ì                      | ë‹¨ì                    |
|--------------------------|------------------------|
| âœ… ë†’ì€ ì²˜ë¦¬ëŸ‰           | âŒ ê²°ê³¼ í´ë§ í•„ìš”      |
| âœ… ìˆ˜í‰ í™•ì¥ ìš©ì´        | âŒ ì¸í”„ë¼ ë³µì¡ë„ ì¦ê°€  |
| âœ… ë©”ì‹œì§€ ìœ ì‹¤ ë°©ì§€      | âŒ ì‹¤ì‹œê°„ ê²°ê³¼ ì–´ë ¤ì›€  |
| âœ… ì¥ì•  ë³µêµ¬ ë‚´ì¥        | âŒ ìš´ì˜ ë³µì¡ë„ ì¦ê°€    |
| âœ… ìˆœì„œ ë³´ì¥ ìì—°ìŠ¤ëŸ¬ì›€  | âŒ ì´ˆê¸° ì„¤ì • ë¹„ìš©      |

---

## 3. E-commerce ì¿ í° ë°œê¸‰ ì‹œë‚˜ë¦¬ì˜¤ ì ìš©

### 3.1 êµ¬í˜„ëœ ì•„í‚¤í…ì²˜

```mermaid
flowchart TD
    subgraph Client["ì‚¬ìš©ì ìš”ì²­"]
        User["ğŸ‘¤ User"]
    end

    subgraph Facade["CouponFacade"]
        Issue["issueAsync(couponId, userId)"]
        Producer["CouponKafkaProducer<br/>â€¢ requestId ìƒì„± (UUID)<br/>â€¢ Key: couponId (íŒŒí‹°ì…”ë‹)<br/>â€¢ Kafkaë¡œ ë©”ì‹œì§€ ì „ì†¡"]
        Issue -->|"í˜¸ì¶œ"| Producer
        Producer -->|"returns: requestId"| Issue
    end

    subgraph Kafka["Kafka Topic: coupon-issue-request"]
        P0["Partition 0<br/>(couponId%3=0)"]
        P1["Partition 1<br/>(couponId%3=1)"]
        P2["Partition 2<br/>(couponId%3=2)"]
    end

    subgraph ConsumerGroup["Consumer Group: coupon-issue-group"]
        C0["Consumer 0<br/>ì²˜ë¦¬ë¡œì§"]
        C1["Consumer 1<br/>ì²˜ë¦¬ë¡œì§"]
        C2["Consumer 2<br/>ì²˜ë¦¬ë¡œì§"]
    end

    subgraph Database["Database"]
        Coupon["COUPON<br/>(ì¬ê³  ê´€ë¦¬)"]
        UserCoupon["USER_COUPON<br/>(ë°œê¸‰ ì´ë ¥)"]
        Result["COUPON_ISSUE_RESULT<br/>(ê²°ê³¼ ì €ì¥/í´ë§)"]
    end

    User --> Issue
    Producer --> P0 & P1 & P2
    P0 --> C0
    P1 --> C1
    P2 --> C2
    C0 & C1 & C2 --> Coupon & UserCoupon & Result
```

### 3.2 íŒŒí‹°ì…”ë‹ ì „ëµ íš¨ê³¼

#### ë¬¸ì œ ìƒí™©: ì„ ì°©ìˆœ 100ëª… ì¿ í° ë°œê¸‰

ë™ì‹œ ìš”ì²­ 500ê±´ì´ ë“¤ì–´ì˜¤ëŠ” ìƒí™©:

```mermaid
flowchart LR
    subgraph Requests["ë™ì‹œ ìš”ì²­ 500ê±´"]
        U1["User1 â†’ Coupon1"]
        U2["User2 â†’ Coupon1"]
        U3["User3 â†’ Coupon1"]
        U101["User101 â†’ Coupon1"]
        U102["User102 â†’ Coupon1"]
        dots1["..."]
    end
```

#### í•´ê²°: ë™ì¼ couponId â†’ ë™ì¼ Partition â†’ ìˆœì°¨ ì²˜ë¦¬

```mermaid
flowchart LR
    subgraph Partition0["Partition 0 (couponId=1)"]
        direction LR
        U1["User1"] -->|"ë°œê¸‰1"| U2["User2"]
        U2 -->|"ë°œê¸‰2"| U3["User3"]
        U3 -->|"..."| U100["User100"]
        U100 -->|"ë°œê¸‰100"| U101["User101"]
        U101 -->|"âŒ ì¬ê³ ì†Œì§„"| U102["User102..."]
    end
```

**ê²°ê³¼:**
- âœ… **ì„ ì°©ìˆœ ë³´ì¥**: ë¨¼ì € Kafkaì— ë„ì°©í•œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬
- âœ… **ê²½ìŸ ì—†ìŒ**: ë‹¨ì¼ Consumerê°€ ìˆœì°¨ ì²˜ë¦¬
- âœ… **ì •í™•íˆ 100ëª…ë§Œ ë°œê¸‰**

### 3.3 ì²˜ë¦¬ íë¦„ ì‹œí€€ìŠ¤

```mermaid
sequenceDiagram
    autonumber
    participant User as ğŸ‘¤ User
    participant API as ğŸŒ API Server
    participant Kafka as ğŸ“¨ Kafka
    participant Consumer as âš™ï¸ Consumer
    participant DB as ğŸ—„ï¸ Database

    User->>API: POST /coupons/1/issue
    API->>Kafka: send(key=1)
    API-->>User: requestId ë°˜í™˜

    Note over Kafka,Consumer: ë¹„ë™ê¸° ì²˜ë¦¬

    Kafka->>Consumer: consume()
    Consumer->>DB: ë©±ë“±ì„± ì²´í¬
    DB-->>Consumer: OK
    Consumer->>DB: ì¬ê³  ì°¨ê°
    DB-->>Consumer: OK
    Consumer->>DB: UserCoupon ì €ì¥
    DB-->>Consumer: OK
    Consumer->>DB: ê²°ê³¼ ì €ì¥

    Note over User,API: í´ë§ìœ¼ë¡œ ê²°ê³¼ ì¡°íšŒ

    User->>API: GET /coupons/result/{requestId}
    API->>DB: ê²°ê³¼ ì¡°íšŒ
    DB-->>API: ë°œê¸‰ ê²°ê³¼
    API-->>User: ê²°ê³¼ ë°˜í™˜
```

---

## 4. í•™ìŠµ ìš”ì•½ ë° ê¶Œì¥ì‚¬í•­

### 4.1 í•µì‹¬ í•™ìŠµ í¬ì¸íŠ¸

#### í•µì‹¬ í•™ìŠµ ìš”ì•½

**1. Partitionì€ ë³‘ë ¬ì„±ì˜ ë‹¨ìœ„**
- Consumer ìˆ˜ â‰¤ Partition ìˆ˜ ìœ ì§€
- ë™ì¼ Key â†’ ë™ì¼ Partition â†’ ìˆœì„œ ë³´ì¥

**2. Consumer Groupì€ í™•ì¥ì„±ì˜ í•µì‹¬**
- Group ë‚´ Consumerë“¤ì´ Partition ë¶„ë‹´
- Rebalancingìœ¼ë¡œ ìë™ ë¶€í•˜ ë¶„ì‚°

**3. acks=allë¡œ ë©”ì‹œì§€ ìœ ì‹¤ ë°©ì§€**
- Leader + ëª¨ë“  ISRì— ë³µì œ í›„ í™•ì¸
- ì²˜ë¦¬ëŸ‰ vs ì•ˆì •ì„± íŠ¸ë ˆì´ë“œì˜¤í”„

**4. ë©±ë“±ì„±(Idempotency) í•„ìˆ˜**
- requestIdë¡œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
- Consumer ì¬ì‹œì‘/ì¬ì²˜ë¦¬ ì‹œ ì•ˆì „

**5. ë¹„ë™ê¸° íŒ¨í„´ = ìš”ì²­ ë¶„ë¦¬ + ê²°ê³¼ í´ë§**
- ìš”ì²­ ì ‘ìˆ˜ì™€ ì²˜ë¦¬ ë¶„ë¦¬
- ì‚¬ìš©ì ê²½í—˜ì„ ìœ„í•œ í´ë§ API í•„ìš”

### 4.2 ì‹œë‚˜ë¦¬ì˜¤ë³„ ê¶Œì¥ ì†”ë£¨ì…˜

| ì‹œë‚˜ë¦¬ì˜¤               | ê¶Œì¥ ì†”ë£¨ì…˜ | ì´ìœ                    |
|------------------------|-------------|------------------------|
| ì‹¤ì‹œê°„ ì¬ê³  í™•ì¸ í•„ìš”  | Redis       | ì¦‰ê°ì  ì‘ë‹µ í•„ìš”       |
| ëŒ€ê·œëª¨ ì„ ì°©ìˆœ ì´ë²¤íŠ¸   | Kafka       | ë†’ì€ ì²˜ë¦¬ëŸ‰, ìˆœì„œ ë³´ì¥ |
| ê°„ë‹¨í•œ ë™ì‹œì„± ì œì–´     | Redis       | êµ¬í˜„ ë‹¨ìˆœ              |
| ì¥ì•  ë³µêµ¬ ì¤‘ìš”         | Kafka       | offset ê¸°ë°˜ ì¬ì²˜ë¦¬     |
| ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ í†µì‹  | Kafka       | ëŠìŠ¨í•œ ê²°í•©            |
| ë³µì¡í•œ ì´ë²¤íŠ¸ ì²˜ë¦¬     | Kafka       | ì´ë²¤íŠ¸ ì†Œì‹± ê°€ëŠ¥       |

### 4.3 ì‹¤ìŠµ í™˜ê²½ ë° í…ŒìŠ¤íŠ¸ ë¡œê·¸

#### ì‹¤ìŠµ í™˜ê²½
- **Kafka**: Testcontainers (confluentinc/cp-kafka:7.5.0)
- **í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬**: Spring Boot Test + JUnit 5
- **í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤**: `KafkaIntegrationTest.java`

---

#### í…ŒìŠ¤íŠ¸ 1: ì£¼ë¬¸ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰/ìˆ˜ì‹ 

```
========================================
[í…ŒìŠ¤íŠ¸ ì‹œì‘] ì£¼ë¬¸ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰/ìˆ˜ì‹ 
[Kafka] Bootstrap Servers: PLAINTEXT://localhost:52928
========================================

========================================
[Kafka Producer] ë©”ì‹œì§€ ë°œí–‰ ì‹œì‘
[Kafka Producer] Topic: order-completed-test1
[Kafka Producer] Key: 1001
[Kafka Producer] OrderId: 1001
[Kafka Producer] Products: {102=1, 101=2}
========================================

========================================
[Kafka Producer] ë°œí–‰ ì™„ë£Œ!
[Kafka Producer] Topic: order-completed-test1
[Kafka Producer] Partition: 0
[Kafka Producer] Offset: 0
[Kafka Producer] Timestamp: 1765800688527
========================================

========================================
[Kafka Consumer] ë©”ì‹œì§€ ìˆ˜ì‹  ì„±ê³µ!
[Kafka Consumer] Topic: order-completed-test1
[Kafka Consumer] Partition: 0
[Kafka Consumer] Offset: 0
[Kafka Consumer] Key: 1001
[Kafka Consumer] OrderId: 1001
[Kafka Consumer] Products: {102=1, 101=2}
========================================

========================================
[í…ŒìŠ¤íŠ¸ ì™„ë£Œ] ì£¼ë¬¸ ì™„ë£Œ ì´ë²¤íŠ¸ ì •ìƒ ë°œí–‰/ìˆ˜ì‹  í™•ì¸!
[ê²€ì¦] Key: 1001 âœ“
[ê²€ì¦] OrderId: 1001 âœ“
[ê²€ì¦] Products: {102=1, 101=2} âœ“
========================================
```

**ì‹¤í–‰ íë¦„ ìš”ì•½**:
1. Producerê°€ `order-completed-test1` í† í”½ì— ë©”ì‹œì§€ ë°œí–‰
2. ë©”ì‹œì§€ê°€ Partition 0, Offset 0ì— ì €ì¥ë¨
3. Consumerê°€ ë™ì¼ í† í”½ì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ 
4. Key, OrderId, Products ë°ì´í„° ì¼ì¹˜ ê²€ì¦ ì™„ë£Œ

---

#### í…ŒìŠ¤íŠ¸ 2: ê²°ì œ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰/ìˆ˜ì‹ 

```
========================================
[í…ŒìŠ¤íŠ¸ ì‹œì‘] ê²°ì œ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰/ìˆ˜ì‹ 
========================================

========================================
[Kafka Producer] ê²°ì œ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰
[Kafka Producer] Topic: payment-completed
[Kafka Producer] Version: 1
[Kafka Producer] OrderId: 2001
[Kafka Producer] UserId: 1
[Kafka Producer] TotalAmount: 50000ì›
[Kafka Producer] DiscountAmount: 5000ì›
[Kafka Producer] FinalAmount: 45000ì›
[Kafka Producer] OrderItems: [OrderItemInfo[productId=101, productName=ë…¸íŠ¸ë¶, optionName=ì‹¤ë²„, quantity=1, unitPrice=50000, subTotal=50000]]
========================================

[Kafka Producer] ë°œí–‰ ì™„ë£Œ - partition: 0, offset: 0

========================================
[Kafka Consumer] ê²°ì œ ì™„ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹ !
[Kafka Consumer] Topic: payment-completed
[Kafka Consumer] Partition: 0
[Kafka Consumer] Offset: 0
[Kafka Consumer] Key: 2001
[Kafka Consumer] Version: 1
[Kafka Consumer] OrderId: 2001
[Kafka Consumer] UserId: 1
[Kafka Consumer] TotalAmount: 50000ì›
[Kafka Consumer] DiscountAmount: 5000ì›
[Kafka Consumer] FinalAmount: 45000ì›
[Kafka Consumer] UserPhone: 010-1234-5678
[Kafka Consumer] OrderItems: [OrderItemInfo[productId=101, productName=ë…¸íŠ¸ë¶, optionName=ì‹¤ë²„, quantity=1, unitPrice=50000, subTotal=50000]]
========================================

========================================
[í…ŒìŠ¤íŠ¸ ì™„ë£Œ] ê²°ì œ ì™„ë£Œ ì´ë²¤íŠ¸ ì •ìƒ ë°œí–‰/ìˆ˜ì‹ !
[ê²€ì¦] Version: 1 âœ“
[ê²€ì¦] OrderId: 2001 âœ“
[ê²€ì¦] FinalAmount: 45000ì› âœ“
========================================
```

**ì‹¤í–‰ íë¦„ ìš”ì•½**:
1. ê²°ì œ ì •ë³´(ì£¼ë¬¸ID, ì‚¬ìš©ìID, ê¸ˆì•¡, ìƒí’ˆì •ë³´)ë¥¼ ë‹´ì€ ì´ë²¤íŠ¸ ìƒì„±
2. `payment-completed` í† í”½ìœ¼ë¡œ ë©”ì‹œì§€ ë°œí–‰
3. Consumerê°€ ì´ë²¤íŠ¸ ìˆ˜ì‹  ë° ëª¨ë“  í•„ë“œ ê²€ì¦
4. í• ì¸ ì ìš© ê¸ˆì•¡(50,000 - 5,000 = 45,000ì›) ì •ìƒ ì²˜ë¦¬ í™•ì¸

---

#### í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ëª…ë ¹ì–´

```bash
# ì „ì²´ Kafka í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./gradlew test --tests "org.hhplus.hhecommerce.infrastructure.kafka.KafkaIntegrationTest" --info

# íŠ¹ì • í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
./gradlew test --tests "KafkaIntegrationTest.testOrderCompletedEvent_PublishAndConsume" --info
```

---

#### CLI ì‹¤ìŠµ: Docker + Kafka ë©”ì‹œì§€ ì†¡ìˆ˜ì‹ 

##### í™˜ê²½ êµ¬ì„±

```bash
# Docker Composeë¡œ Kafka í™˜ê²½ ì‹¤í–‰
docker-compose up -d

# ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
docker-compose ps
```

**ì‹¤í–‰ ê²°ê³¼:**
```
NAME                  IMAGE                             STATUS                    PORTS
ecommerce-kafka       confluentinc/cp-kafka:7.5.0       Up (healthy)              0.0.0.0:9092->9092/tcp
ecommerce-kafka-ui    provectuslabs/kafka-ui:latest     Up                        0.0.0.0:8090->8080/tcp
ecommerce-zookeeper   confluentinc/cp-zookeeper:7.5.0   Up (healthy)              0.0.0.0:2181->2181/tcp
```

##### í† í”½ ìƒì„± ë° í™•ì¸

```bash
# í† í”½ ìƒì„± (3ê°œ íŒŒí‹°ì…˜)
docker exec ecommerce-kafka kafka-topics --create \
  --bootstrap-server localhost:9092 \
  --topic order-completed \
  --partitions 3 \
  --replication-factor 1
```

**ì‹¤í–‰ ê²°ê³¼:**
```
Created topic order-completed.
```

```bash
# í† í”½ ìƒì„¸ ì •ë³´ í™•ì¸
docker exec ecommerce-kafka kafka-topics --describe \
  --bootstrap-server localhost:9092 \
  --topic order-completed
```

**ì‹¤í–‰ ê²°ê³¼:**
```
Topic: order-completed  PartitionCount: 3  ReplicationFactor: 1
    Topic: order-completed  Partition: 0  Leader: 1  Replicas: 1  Isr: 1
    Topic: order-completed  Partition: 1  Leader: 1  Replicas: 1  Isr: 1
    Topic: order-completed  Partition: 2  Leader: 1  Replicas: 1  Isr: 1
```

##### ë©”ì‹œì§€ ë°œí–‰ (Producer)

```bash
# ë‹¨ì¼ ë©”ì‹œì§€ ë°œí–‰
echo '{"orderId":1001,"products":{"101":2,"102":1}}' | \
  docker exec -i ecommerce-kafka kafka-console-producer \
  --bootstrap-server localhost:9092 \
  --topic order-completed

# ì—¬ëŸ¬ ë©”ì‹œì§€ ë°œí–‰
for i in 1 2 3 4 5; do
  echo "{\"orderId\":200$i,\"userId\":$i,\"amount\":$((i*10000))}" | \
    docker exec -i ecommerce-kafka kafka-console-producer \
    --bootstrap-server localhost:9092 \
    --topic order-completed
done
```

##### ë©”ì‹œì§€ ìˆ˜ì‹  (Consumer)

```bash
# ì²˜ìŒë¶€í„° ëª¨ë“  ë©”ì‹œì§€ ìˆ˜ì‹ 
docker exec ecommerce-kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic order-completed \
  --from-beginning \
  --max-messages 10
```

**ì‹¤í–‰ ê²°ê³¼:**
```
{"orderId":2001,"userId":1,"amount":10000}
{"orderId":2005,"userId":5,"amount":50000}
{"orderId":1001,"products":{"101":2,"102":1}}
{"orderId":2002,"userId":2,"amount":20000}
{"orderId":2003,"userId":3,"amount":30000}
{"orderId":2004,"userId":4,"amount":40000}
Processed a total of 6 messages
```

> **ì°¸ê³ **: ë©”ì‹œì§€ ìˆœì„œê°€ ë°œí–‰ ìˆœì„œì™€ ë‹¤ë¥¸ ì´ìœ ëŠ” 3ê°œ íŒŒí‹°ì…˜ì— ë¶„ì‚° ì €ì¥ë˜ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
> ë™ì¼ íŒŒí‹°ì…˜ ë‚´ì—ì„œëŠ” ìˆœì„œê°€ ë³´ì¥ë©ë‹ˆë‹¤.

##### Kafka UI ì ‘ì†

- **URL**: http://localhost:8090
- **ê¸°ëŠ¥**: í† í”½ ì¡°íšŒ, ë©”ì‹œì§€ ë°œí–‰/ìˆ˜ì‹ , Consumer Group ëª¨ë‹ˆí„°ë§

---

### 4.5 ìš´ì˜ ì‹œ ê³ ë ¤ì‚¬í•­

#### ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

**ëª¨ë‹ˆí„°ë§**
- Consumer Lag (ì§€ì—°ë˜ëŠ” ë©”ì‹œì§€ ìˆ˜)
- Partitionë³„ ì²˜ë¦¬ëŸ‰
- Producer ì „ì†¡ ì‹¤íŒ¨ìœ¨
- Broker ë””ìŠ¤í¬/ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

**íŠœë‹ í¬ì¸íŠ¸**
- `batch.size`: ë°°ì¹˜ í¬ê¸° (ì²˜ë¦¬ëŸ‰ â†‘)
- `linger.ms`: ëŒ€ê¸° ì‹œê°„ (ì²˜ë¦¬ëŸ‰ vs ì§€ì—° íŠ¸ë ˆì´ë“œì˜¤í”„)
- `max.poll.records`: í•œ ë²ˆì— ê°€ì ¸ì˜¬ ë ˆì½”ë“œ ìˆ˜
- `session.timeout.ms`: Consumer ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ

**ì£¼ì˜ì‚¬í•­**
- Partition ìˆ˜ëŠ” ì¤„ì¼ ìˆ˜ ì—†ìŒ (ì‹ ì¤‘í•˜ê²Œ ì„¤ì •)
- Hot Partition ë°œìƒ ì‹œ Key ë¶„ì‚° ì „ëµ ì¬ê²€í† 
- Consumer ì¬ì‹œì‘ ì‹œ Rebalancing ë°œìƒ
- ë©”ì‹œì§€ ìˆœì„œê°€ ì¤‘ìš”í•˜ë©´ ë‹¨ì¼ Partition ê³ ë ¤

### 4.6 ê²°ë¡ 

#### ìµœì¢… ê²°ë¡ 

E-commerce ì¿ í° ë°œê¸‰ ì‹œìŠ¤í…œì—ì„œ:

> **"ëŒ€ê·œëª¨ ì„ ì°©ìˆœ ì´ë²¤íŠ¸ì—ëŠ” Kafka ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬ê°€ ì í•©"**
>
> - ë†’ì€ ì²˜ë¦¬ëŸ‰ (10,000+ TPS)
> - Partition Keyë¡œ ìˆœì„œ ë³´ì¥
> - Consumer í™•ì¥ìœ¼ë¡œ ìœ ì—°í•œ ìŠ¤ì¼€ì¼ë§
> - ì¥ì•  ì‹œ offset ê¸°ë°˜ ë³µêµ¬

> **"ì¼ë°˜ì ì¸ ì¿ í° ë°œê¸‰ì—ëŠ” Redis ê¸°ë°˜ ë™ê¸° ì²˜ë¦¬ë„ ì¶©ë¶„"**
>
> - ê°„ë‹¨í•œ êµ¬í˜„
> - ì¦‰ê°ì ì¸ ê²°ê³¼ ë°˜í™˜
> - ì‘ì€ ê·œëª¨ì— ì í•©

**â†’ íŠ¸ë˜í”½ ê·œëª¨ì™€ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ì ì ˆí•œ ì†”ë£¨ì…˜ ì„ íƒ í•„ìš”**

---

## 4.7 ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤ìŠµ ë¡œê·¸

### 4.7.1 ì‹¤ìŠµ í™˜ê²½

| í•­ëª©                  | ì„¤ì •                                         |
|-----------------------|----------------------------------------------|
| **Kafka**             | Testcontainers (confluentinc/cp-kafka:7.5.0) |
| **í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬** | JUnit 5 + Spring Kafka                       |
| **í† í”½ ì„¤ì •**         | 3ê°œ íŒŒí‹°ì…˜, 1ê°œ ë ˆí”Œë¦¬ì¹´                     |
| **í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤**     | `CouponKafkaIntegrationTest.java`            |

#### ì‹¤í–‰ ëª…ë ¹ì–´

```bash
./gradlew test --tests "org.hhplus.hhecommerce.infrastructure.kafka.CouponKafkaIntegrationTest" --info
```

---

### 4.7.2 í…ŒìŠ¤íŠ¸ 1: íŒŒí‹°ì…”ë‹ ì „ëµ - ë™ì¼ couponId â†’ ë™ì¼ íŒŒí‹°ì…˜

#### ì‹œë‚˜ë¦¬ì˜¤
- **ëª©ì **: ë™ì¼í•œ ì¿ í°ì— ëŒ€í•œ ëª¨ë“  ìš”ì²­ì´ ê°™ì€ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¼ìš°íŒ…ë˜ëŠ”ì§€ ê²€ì¦
- **ì„¤ì •**: couponId=1ë¡œ 10ê±´ì˜ ìš”ì²­ ë°œí–‰
- **ê¸°ëŒ€ê²°ê³¼**: ëª¨ë“  ë©”ì‹œì§€ê°€ ë™ì¼í•œ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¼ìš°íŒ…

#### ì‹¤í–‰ ë¡œê·¸

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  í…ŒìŠ¤íŠ¸ 1: íŒŒí‹°ì…”ë‹ ì „ëµ - ë™ì¼ couponId â†’ ë™ì¼ íŒŒí‹°ì…˜            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[ì‹œë‚˜ë¦¬ì˜¤] couponId=1 ë¡œ 10ê±´ì˜ ìš”ì²­ ë°œí–‰
[ê¸°ëŒ€ê²°ê³¼] ëª¨ë“  ë©”ì‹œì§€ê°€ ë™ì¼í•œ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¼ìš°íŒ…

[Producer] ë°œí–‰ #1 - key: 1, partition: 0, offset: 0, userId: 1
[Producer] ë°œí–‰ #2 - key: 1, partition: 0, offset: 1, userId: 2
[Producer] ë°œí–‰ #3 - key: 1, partition: 0, offset: 2, userId: 3
[Producer] ë°œí–‰ #4 - key: 1, partition: 0, offset: 3, userId: 4
[Producer] ë°œí–‰ #5 - key: 1, partition: 0, offset: 4, userId: 5
[Producer] ë°œí–‰ #6 - key: 1, partition: 0, offset: 5, userId: 6
[Producer] ë°œí–‰ #7 - key: 1, partition: 0, offset: 6, userId: 7
[Producer] ë°œí–‰ #8 - key: 1, partition: 0, offset: 7, userId: 8
[Producer] ë°œí–‰ #9 - key: 1, partition: 0, offset: 8, userId: 9
[Producer] ë°œí–‰ #10 - key: 1, partition: 0, offset: 9, userId: 10

[ê²€ì¦ í†µê³¼] âœ… ë™ì¼ couponIdì˜ ëª¨ë“  ë©”ì‹œì§€ê°€ íŒŒí‹°ì…˜ 0ë¡œ ë¼ìš°íŒ…ë¨
```

**ê²°ê³¼**: ì‚¬ìš©ëœ íŒŒí‹°ì…˜ = [0] (ì´ 1ê°œ)

#### í•µì‹¬ í¬ì¸íŠ¸
- **ë©”ì‹œì§€ í‚¤**: `couponId`ë§Œ ì‚¬ìš© (ì„ ì°©ìˆœ ë³´ì¥ì„ ìœ„í•´ ë™ì¼ ì¿ í°ì€ ë™ì¼ íŒŒí‹°ì…˜ìœ¼ë¡œ)
- **í•´ì‹œ ì•Œê³ ë¦¬ì¦˜**: Kafkaì˜ ê¸°ë³¸ íŒŒí‹°ì…”ë„ˆê°€ í‚¤ì˜ í•´ì‹œê°’ì„ ê¸°ë°˜ìœ¼ë¡œ íŒŒí‹°ì…˜ ê²°ì •
- **ê²°ê³¼**: ë™ì¼ couponIdë¥¼ ê°€ì§„ ëª¨ë“  ìš”ì²­ì´ **íŒŒí‹°ì…˜ 0**ìœ¼ë¡œ ì¼ê´€ë˜ê²Œ ë¼ìš°íŒ…

---

### 4.7.3 í…ŒìŠ¤íŠ¸ 2: íŒŒí‹°ì…”ë‹ ì „ëµ - ë‹¤ë¥¸ couponId â†’ íŒŒí‹°ì…˜ ë¶„ì‚°

#### ì‹œë‚˜ë¦¬ì˜¤
- **ëª©ì **: ë‹¤ë¥¸ ì¿ í°ë“¤ì´ ì—¬ëŸ¬ íŒŒí‹°ì…˜ì— ë¶„ì‚°ë˜ëŠ”ì§€ ê²€ì¦
- **ì„¤ì •**: 9ì¢…ë¥˜ì˜ ì¿ í°(couponId 1~9)ì— ëŒ€í•´ ê°ê° ë°œê¸‰ ìš”ì²­
- **ê¸°ëŒ€ê²°ê³¼**: ë©”ì‹œì§€ê°€ ì—¬ëŸ¬ íŒŒí‹°ì…˜ì— ë¶„ì‚°

> **ì°¸ê³ **: í…ŒìŠ¤íŠ¸ 1ê³¼ í…ŒìŠ¤íŠ¸ 2ëŠ” **ì„œë¡œ ë‹¤ë¥¸ í† í”½**ì„ ì‚¬ìš©í•˜ì—¬ ë…ë¦½ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ë™ì¼í•œ couponId=1ì´ë¼ë„ íŒŒí‹°ì…˜ í• ë‹¹ ê²°ê³¼ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Kafka íŒŒí‹°ì…”ë„ˆëŠ” í† í”½ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘)

#### ì‹¤í–‰ ë¡œê·¸

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  í…ŒìŠ¤íŠ¸ 2: íŒŒí‹°ì…”ë‹ ì „ëµ - ë‹¤ë¥¸ couponId â†’ íŒŒí‹°ì…˜ ë¶„ì‚°            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[ì‹œë‚˜ë¦¬ì˜¤] 9 ì¢…ë¥˜ì˜ ì¿ í°ì— ëŒ€í•´ ê°ê° ë°œê¸‰ ìš”ì²­
[ê¸°ëŒ€ê²°ê³¼] ë©”ì‹œì§€ê°€ ì—¬ëŸ¬ íŒŒí‹°ì…˜ì— ë¶„ì‚°

[Producer] couponId: 1 â†’ partition: 1
[Producer] couponId: 2 â†’ partition: 0
[Producer] couponId: 3 â†’ partition: 0
[Producer] couponId: 4 â†’ partition: 2
[Producer] couponId: 5 â†’ partition: 2
[Producer] couponId: 6 â†’ partition: 1
[Producer] couponId: 7 â†’ partition: 1
[Producer] couponId: 8 â†’ partition: 0
[Producer] couponId: 9 â†’ partition: 0

[ê²€ì¦ í†µê³¼] âœ… ë©”ì‹œì§€ê°€ 3ê°œ íŒŒí‹°ì…˜ì— ë¶„ì‚°ë¨
```

**íŒŒí‹°ì…˜ë³„ ì¿ í° ë¶„í¬:**
- Partition 0: couponIds = [2, 3, 8, 9]
- Partition 1: couponIds = [1, 6, 7]
- Partition 2: couponIds = [4, 5]
- ì‚¬ìš©ëœ íŒŒí‹°ì…˜ ìˆ˜: 3

#### í•µì‹¬ í¬ì¸íŠ¸
- ë‹¤ë¥¸ couponIdëŠ” **í•´ì‹œê°’ì— ë”°ë¼ ë‹¤ë¥¸ íŒŒí‹°ì…˜**ìœ¼ë¡œ ë¶„ì‚°
- 3ê°œ íŒŒí‹°ì…˜ì— ë¶„ë°° (í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ì— ë”°ë¼ ë¶„í¬ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŒ)
- ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥: ë‹¤ë¥¸ ì¿ í°ë“¤ì€ ë™ì‹œì— ì²˜ë¦¬ ê°€ëŠ¥

---

### 4.7.4 í…ŒìŠ¤íŠ¸ 3: Consumer ë³‘ë ¬ í™•ì¥

#### ì‹œë‚˜ë¦¬ì˜¤
- **ëª©ì **: ë‹¤ì¤‘ Consumerê°€ ë³‘ë ¬ë¡œ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ”ì§€ ê²€ì¦
- **ì„¤ì •**: 30ê°œ ë©”ì‹œì§€ ë°œí–‰, 3ê°œ Consumer ë³‘ë ¬ ì²˜ë¦¬
- **ê¸°ëŒ€ê²°ê³¼**: ê° íŒŒí‹°ì…˜ë³„ë¡œ ë³‘ë ¬ ì²˜ë¦¬

#### ì‹¤í–‰ ë¡œê·¸

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  í…ŒìŠ¤íŠ¸ 3: Consumer ë³‘ë ¬ í™•ì¥ - ë‹¤ì¤‘ íŒŒí‹°ì…˜ ë™ì‹œ ì†Œë¹„             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[ì‹œë‚˜ë¦¬ì˜¤] 30ê°œ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•˜ê³  3ê°œ Consumerê°€ ë³‘ë ¬ ì²˜ë¦¬
[ì„¤ì •] í† í”½ íŒŒí‹°ì…˜: 3, Consumer ë³‘ë ¬ë„: 3

[Producer] 30ê°œ ë©”ì‹œì§€ ë°œí–‰ ì‹œì‘...
[Producer] ë°œí–‰ ì™„ë£Œ

[Consumer] partition: 0, offset: 0, thread: noBeanNameSet-0-C-1, couponId: 1, userId: 0
[Consumer] partition: 1, offset: 0, thread: noBeanNameSet-1-C-1, couponId: 1, userId: 3
[Consumer] partition: 2, offset: 0, thread: noBeanNameSet-2-C-1, couponId: 3, userId: 2
[Consumer] partition: 0, offset: 1, thread: noBeanNameSet-0-C-1, couponId: 2, userId: 1
[Consumer] partition: 1, offset: 1, thread: noBeanNameSet-1-C-1, couponId: 3, userId: 5
[Consumer] partition: 2, offset: 1, thread: noBeanNameSet-2-C-1, couponId: 3, userId: 8
...

[ê²€ì¦ í†µê³¼] âœ… ëª¨ë“  ë©”ì‹œì§€ê°€ ë³‘ë ¬ë¡œ ì²˜ë¦¬ë¨
```

**íŒŒí‹°ì…˜ë³„ ì²˜ë¦¬ í˜„í™©:**
- Partition 0: 12ê±´ ì²˜ë¦¬, ìŠ¤ë ˆë“œ: [noBeanNameSet-0-C-1]
- Partition 1: 12ê±´ ì²˜ë¦¬, ìŠ¤ë ˆë“œ: [noBeanNameSet-1-C-1]
- Partition 2: 6ê±´ ì²˜ë¦¬, ìŠ¤ë ˆë“œ: [noBeanNameSet-2-C-1]
- ì´ ì²˜ë¦¬: 30ê±´ / 30ê±´

#### í•µì‹¬ í¬ì¸íŠ¸
- **ConcurrentMessageListenerContainer** ì‚¬ìš©ìœ¼ë¡œ ë³‘ë ¬ ì²˜ë¦¬
- ê° íŒŒí‹°ì…˜ë§ˆë‹¤ **ì „ìš© ìŠ¤ë ˆë“œ**ê°€ í• ë‹¹ë¨
- **ì²˜ë¦¬ëŸ‰ = íŒŒí‹°ì…˜ ìˆ˜ Ã— ë‹¨ì¼ Consumer ì²˜ë¦¬ëŸ‰**

---

### 4.7.5 í…ŒìŠ¤íŠ¸ 4: ìˆœì„œ ë³´ì¥ - ì„ ì°©ìˆœ ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤
- **ëª©ì **: ë™ì¼ couponId ë‚´ì—ì„œ ë©”ì‹œì§€ ìˆœì„œê°€ ë³´ì¥ë˜ëŠ”ì§€ ê²€ì¦
- **ì„¤ì •**: couponId=100ìœ¼ë¡œ 20ëª…ì´ ìˆœì°¨ ìš”ì²­ (userId 1â†’20)
- **ê¸°ëŒ€ê²°ê³¼**: Kafkaì— ë„ì°©í•œ ìˆœì„œëŒ€ë¡œ Consumerê°€ ì²˜ë¦¬

#### ì‹¤í–‰ ë¡œê·¸

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  í…ŒìŠ¤íŠ¸ 4: ìˆœì„œ ë³´ì¥ - ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ì‹œë‚˜ë¦¬ì˜¤                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[ì‹œë‚˜ë¦¬ì˜¤] ì„ ì°©ìˆœ ì¿ í°(couponId=100) ë°œê¸‰ - 20ëª… ë™ì‹œ ìš”ì²­
[ê¸°ëŒ€ê²°ê³¼] Kafkaì— ë„ì°©í•œ ìˆœì„œëŒ€ë¡œ Consumerê°€ ì²˜ë¦¬ (ìˆœì„œ ë³´ì¥)

[Producer] ë°œí–‰ ìˆœì„œ: userId 1 â†’ 2 â†’ 3 â†’ ... â†’ 20
[Producer] ë°œí–‰ #1 - userId: 1, partition: 0, offset: 0
[Producer] ë°œí–‰ #2 - userId: 2, partition: 0, offset: 1
[Producer] ë°œí–‰ #3 - userId: 3, partition: 0, offset: 2
...
[Producer] ë°œí–‰ #20 - userId: 20, partition: 0, offset: 19

[Consumer] ìˆœì„œ #1 - userId: 1, offset: 0, partition: 0
[Consumer] ìˆœì„œ #2 - userId: 2, offset: 1, partition: 0
[Consumer] ìˆœì„œ #3 - userId: 3, offset: 2, partition: 0
[Consumer] ìˆœì„œ #4 - userId: 4, offset: 3, partition: 0
[Consumer] ìˆœì„œ #5 - userId: 5, offset: 4, partition: 0
...
[Consumer] ìˆœì„œ #20 - userId: 20, offset: 19, partition: 0

[ê²€ì¦ í†µê³¼] âœ… ë™ì¼ couponId ë‚´ ë©”ì‹œì§€ ìˆœì„œ ë³´ì¥ë¨ (ì„ ì°©ìˆœ ë³´ì¥)
```

**ìˆœì„œ ë¹„êµ:**
- ë°œí–‰ ìˆœì„œ: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, ..., 20]
- ìˆ˜ì‹  ìˆœì„œ: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, ..., 20]
- ìˆœì„œ ì¼ì¹˜: âœ… YES

#### í•µì‹¬ í¬ì¸íŠ¸
- **ë™ì¼ íŒŒí‹°ì…˜ ë‚´ ìˆœì„œ ë³´ì¥**: Kafkaì˜ í•µì‹¬ íŠ¹ì„±
- ì„ ì°©ìˆœ ë°œê¸‰ì— í•„ìˆ˜ì ì¸ **FIFO(First-In-First-Out)** ë³´ì¥
- **Lock ì—†ì´ë„ ë™ì‹œì„± ë¬¸ì œ í•´ê²°**

---

### 4.7.6 í…ŒìŠ¤íŠ¸ 5: ì¤‘ë³µ ë°œê¸‰ ë°©ì§€ - ë©±ë“±ì„±

#### ì‹œë‚˜ë¦¬ì˜¤
- **ëª©ì **: ë™ì¼ requestIdë¡œ ì¤‘ë³µ ìš”ì²­ ì‹œ ê°ì§€ ê°€ëŠ¥í•œì§€ ê²€ì¦
- **ì„¤ì •**: ë™ì¼í•œ requestIdë¡œ 5ë²ˆ ì¤‘ë³µ ìš”ì²­
- **ê¸°ëŒ€ê²°ê³¼**: Consumerì—ì„œ requestId ê¸°ë°˜ ì¤‘ë³µ ê°ì§€ ê°€ëŠ¥

#### ì‹¤í–‰ ë¡œê·¸

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  í…ŒìŠ¤íŠ¸ 5: ì¤‘ë³µ ë°œê¸‰ ë°©ì§€ - ë©±ë“±ì„± í‚¤(requestId) í™œìš©             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[ì‹œë‚˜ë¦¬ì˜¤] ë™ì¼ requestIdë¡œ 5ë²ˆ ì¤‘ë³µ ìš”ì²­
[ì„¤ì •] requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac
[ê¸°ëŒ€ê²°ê³¼] Consumerì—ì„œ requestId ê¸°ë°˜ ì¤‘ë³µ ê°ì§€ ê°€ëŠ¥

[Producer] ë™ì¼ requestIdë¡œ 5ë²ˆ ë°œí–‰
[Producer] ë°œí–‰ #1 - requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac, partition: 0, offset: 0
[Producer] ë°œí–‰ #2 - requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac, partition: 0, offset: 1
[Producer] ë°œí–‰ #3 - requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac, partition: 0, offset: 2
[Producer] ë°œí–‰ #4 - requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac, partition: 0, offset: 3
[Producer] ë°œí–‰ #5 - requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac, partition: 0, offset: 4

[Consumer] âœ… ì²« ë²ˆì§¸ ìš”ì²­ ì²˜ë¦¬ - requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac
[Consumer] âš ï¸  ì¤‘ë³µ ìš”ì²­ ê°ì§€! (2ë²ˆì§¸) - requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac
[Consumer] âš ï¸  ì¤‘ë³µ ìš”ì²­ ê°ì§€! (3ë²ˆì§¸) - requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac
[Consumer] âš ï¸  ì¤‘ë³µ ìš”ì²­ ê°ì§€! (4ë²ˆì§¸) - requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac
[Consumer] âš ï¸  ì¤‘ë³µ ìš”ì²­ ê°ì§€! (5ë²ˆì§¸) - requestId: REQ-4db31415-81c5-43f2-bd54-822341643aac

[ê²€ì¦ í†µê³¼] âœ… ì¤‘ë³µ ìš”ì²­ì´ ëª¨ë‘ Consumerì— ë„ë‹¬ â†’ ë©±ë“±ì„± ì²´í¬ í•„ìš”ì„± í™•ì¸
```

**ì¤‘ë³µ ìš”ì²­ ë¶„ì„:**
- requestId: REQ-4db31415-81c5-43... â†’ 5ë²ˆ ìˆ˜ì‹ 
- **ê²°ë¡ **: Consumerì—ì„œ requestId ê¸°ë°˜ ë©±ë“±ì„± ì²´í¬ë¡œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ (ì²« ë²ˆì§¸ ìš”ì²­ë§Œ ì²˜ë¦¬í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ìŠ¤í‚µ)

#### í•µì‹¬ í¬ì¸íŠ¸
- **KafkaëŠ” ì¤‘ë³µ ë©”ì‹œì§€ë¥¼ í•„í„°ë§í•˜ì§€ ì•ŠìŒ**
- **Consumer ì¸¡ ë©±ë“±ì„± ì²˜ë¦¬ í•„ìˆ˜**: requestId ê¸°ë°˜ ì¤‘ë³µ ì²´í¬
- `CouponIssueResultRepository`ì—ì„œ requestId ì¡´ì¬ ì—¬ë¶€ í™•ì¸

---

### 4.7.7 í…ŒìŠ¤íŠ¸ 6: ëŒ€ê·œëª¨ ì„ ì°©ìˆœ ì‹œë‚˜ë¦¬ì˜¤ - 100ëª… ë™ì‹œ ìš”ì²­

#### ì‹œë‚˜ë¦¬ì˜¤
- **ëª©ì **: ëŒ€ê·œëª¨ ë™ì‹œ ìš”ì²­ì—ì„œ ì„ ì°©ìˆœ ë°œê¸‰ì´ ì •í™•íˆ ë™ì‘í•˜ëŠ”ì§€ ê²€ì¦
- **ì„¤ì •**: 100ëª… ë™ì‹œ ìš”ì²­, ì¿ í° ì¬ê³  30ê°œ
- **ê¸°ëŒ€ê²°ê³¼**: ë¨¼ì € ë„ì°©í•œ 30ëª…ë§Œ ë°œê¸‰ ì„±ê³µ

#### ì‹¤í–‰ ë¡œê·¸

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  í…ŒìŠ¤íŠ¸ 6: ëŒ€ê·œëª¨ ì„ ì°©ìˆœ ì‹œë‚˜ë¦¬ì˜¤ - 100ëª… ë™ì‹œ ìš”ì²­               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[ì‹œë‚˜ë¦¬ì˜¤] ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰
[ì„¤ì •] ì´ ìš”ì²­: 100ëª…, ì¿ í° ì¬ê³ : 30ê°œ
[ê¸°ëŒ€ê²°ê³¼] ë¨¼ì € ë„ì°©í•œ 30ëª…ë§Œ ë°œê¸‰ ì„±ê³µ, ë‚˜ë¨¸ì§€ 70ëª…ì€ ì¬ê³  ì†Œì§„

[Producer] 100ëª… ë™ì‹œ ìš”ì²­ ë°œí–‰ ì‹œì‘...
[Producer] 100ê±´ ë°œí–‰ ì™„ë£Œ (ì†Œìš”ì‹œê°„: 82ms)

[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #1 - userId: 2, ë‚¨ì€ ì¬ê³ : 29
[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #2 - userId: 8, ë‚¨ì€ ì¬ê³ : 28
[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #3 - userId: 4, ë‚¨ì€ ì¬ê³ : 27
[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #4 - userId: 9, ë‚¨ì€ ì¬ê³ : 26
[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #5 - userId: 6, ë‚¨ì€ ì¬ê³ : 25
[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #6 - userId: 7, ë‚¨ì€ ì¬ê³ : 24
[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #7 - userId: 1, ë‚¨ì€ ì¬ê³ : 23
[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #8 - userId: 10, ë‚¨ì€ ì¬ê³ : 22
[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #9 - userId: 5, ë‚¨ì€ ì¬ê³ : 21
[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #10 - userId: 3, ë‚¨ì€ ì¬ê³ : 20
...
[Consumer] âœ… ë°œê¸‰ ì„±ê³µ #30 - userId: 33, ë‚¨ì€ ì¬ê³ : 0
[Consumer] âŒ ì¬ê³  ì†Œì§„ - userId: 23
[Consumer] âŒ ì¬ê³  ì†Œì§„ - userId: 25
[Consumer] âŒ ì¬ê³  ì†Œì§„ - userId: 21
...

[ê²€ì¦ í†µê³¼] âœ… ì„ ì°©ìˆœ 30ëª…ë§Œ ë°œê¸‰ ì„±ê³µ, ë‚˜ë¨¸ì§€ëŠ” ì¬ê³  ì†Œì§„ ì²˜ë¦¬
```

**ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ê²°ê³¼:**
- ì´ ìš”ì²­: 100ëª…
- ë°œê¸‰ ì„±ê³µ: 30ëª… (ì„ ì°©ìˆœ)
- ì¬ê³  ì†Œì§„: 70ëª…
- ì²˜ë¦¬ ìˆœì„œ: [2, 8, 4, 9, 6, 7, 1, 10, 5, 3] ... (ì²˜ìŒ 10ëª…)

> **ì°¸ê³ **: ì²˜ë¦¬ ìˆœì„œê°€ userId ìˆœì„œ(1, 2, 3...)ì™€ ë‹¤ë¥¸ ì´ìœ ëŠ” **ë©€í‹°ìŠ¤ë ˆë“œ ë™ì‹œ ë°œí–‰** ë•Œë¬¸ì…ë‹ˆë‹¤. 100ê°œì˜ ìš”ì²­ì´ ë™ì‹œì— Kafkaë¡œ ì „ì†¡ë  ë•Œ, ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì— ë”°ë¼ Kafkaì— ë„ì°©í•˜ëŠ” ìˆœì„œê°€ ë‹¬ë¼ì§‘ë‹ˆë‹¤. **ì¤‘ìš”í•œ ê²ƒì€ Kafkaì— ë¨¼ì € ë„ì°©í•œ ìˆœì„œëŒ€ë¡œ ë°œê¸‰ëœë‹¤ëŠ” ì **ì…ë‹ˆë‹¤.

**ì„±ëŠ¥ ì§€í‘œ:**
- ë°œí–‰ ì†Œìš”ì‹œê°„: 82ms
- ì „ì²´ ì†Œìš”ì‹œê°„: 614ms
- ì²˜ë¦¬ëŸ‰: 162 req/sec

#### í•µì‹¬ í¬ì¸íŠ¸
- **ì •í™•íˆ 30ëª…ë§Œ ë°œê¸‰**: ì¬ê³  ê´€ë¦¬ ì •í™•ì„± ê²€ì¦
- **ì²˜ë¦¬ ìˆœì„œ**: ë©€í‹°ìŠ¤ë ˆë“œ ë°œí–‰ìœ¼ë¡œ Kafka ë„ì°© ìˆœì„œê°€ ë°œí–‰ ìˆœì„œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
- **ë†’ì€ ì²˜ë¦¬ëŸ‰**: 100ê±´ ìš”ì²­ì„ 614ms ë‚´ì— ì²˜ë¦¬ (162 req/sec)

---

### 4.7.8 ì‹¤ìŠµ ì´ìŠˆ ë° í•´ê²°

#### ì´ìŠˆ 1: íŒŒí‹°ì…˜ ê°„ ìˆœì„œ ë³´ì¥ ë¶ˆê°€

**ë¬¸ì œ**:
```
ë™ì‹œ ë°œí–‰ ì‹œ userId ìˆœì„œì™€ ì²˜ë¦¬ ìˆœì„œê°€ ë¶ˆì¼ì¹˜
ë°œí–‰: userId 1, 2, 3, 4, 5...
ì²˜ë¦¬: userId 2, 8, 4, 9, 6...
```

**ì›ì¸**:
- ë©€í‹°ìŠ¤ë ˆë“œë¡œ ë™ì‹œ ë°œí–‰ ì‹œ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì— ë”°ë¼ Kafka ë„ì°© ìˆœì„œê°€ ë‹¬ë¼ì§
- ë‹¨ì¼ íŒŒí‹°ì…˜ ë‚´ì—ì„œë§Œ ìˆœì„œ ë³´ì¥ë¨

**í•´ê²°**:
- **ë™ì¼ couponIdëŠ” ë™ì¼ íŒŒí‹°ì…˜**ìœ¼ë¡œ ë¼ìš°íŒ…í•˜ì—¬ í•´ë‹¹ ì¿ í° ë‚´ ìˆœì„œ ë³´ì¥
- ì „ì—­ ìˆœì„œê°€ í•„ìš”í•˜ë©´ **ë‹¨ì¼ íŒŒí‹°ì…˜** ì‚¬ìš© (ì²˜ë¦¬ëŸ‰ ê°ì†Œ íŠ¸ë ˆì´ë“œì˜¤í”„)

---

#### ì´ìŠˆ 2: Consumer ë³‘ë ¬ë„ì™€ íŒŒí‹°ì…˜ ìˆ˜ ë¶ˆì¼ì¹˜

**ë¬¸ì œ**:
```
Consumer ìˆ˜ > Partition ìˆ˜ â†’ ìœ íœ´ Consumer ë°œìƒ
Consumer ìˆ˜ < Partition ìˆ˜ â†’ ì¼ë¶€ Consumerê°€ ì—¬ëŸ¬ íŒŒí‹°ì…˜ ë‹´ë‹¹
```

**í•´ê²°**:
```java
// ìµœì : Consumer ìˆ˜ = Partition ìˆ˜
container.setConcurrency(PARTITION_COUNT);  // 3ê°œ íŒŒí‹°ì…˜ = 3ê°œ Consumer
```

---

#### ì´ìŠˆ 3: ë©±ë“±ì„± ë¯¸ì²˜ë¦¬ ì‹œ ì¤‘ë³µ ë°œê¸‰

**ë¬¸ì œ**:
- Consumer ì¬ì‹œì‘ ì‹œ ì´ë¯¸ ì²˜ë¦¬ëœ ë©”ì‹œì§€ ì¬ì²˜ë¦¬
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë™ì¼ ìš”ì²­ ì¤‘ë³µ ì „ì†¡

**í•´ê²°**:
```java
// Consumerì—ì„œ ë©±ë“±ì„± ì²´í¬
if (couponIssueResultService.existsByRequestId(request.requestId())) {
    log.info("ì´ë¯¸ ì²˜ë¦¬ëœ ìš”ì²­ - requestId: {}", request.requestId());
    return;  // ìŠ¤í‚µ
}
```

---

### 4.7.9 ì‹¤ìŠµ ê²°ë¡ 

| ì‹¤ìŠµ í•­ëª©            | ê²€ì¦ ê²°ê³¼ | í•µì‹¬ í•™ìŠµ                          |
|----------------------|-----------|-----------------------------------|
| **íŒŒí‹°ì…”ë‹ ì „ëµ**    | âœ… í†µê³¼   | ë™ì¼ Key â†’ ë™ì¼ Partition          |
| **íŒŒí‹°ì…˜ ë¶„ì‚°**      | âœ… í†µê³¼   | ë‹¤ë¥¸ Key â†’ íŒŒí‹°ì…˜ ë¶„ì‚° (ë³‘ë ¬ ì²˜ë¦¬) |
| **Consumer ë³‘ë ¬í™”**  | âœ… í†µê³¼   | Partition ìˆ˜ = Consumer ìˆ˜ ê¶Œì¥    |
| **ìˆœì„œ ë³´ì¥**        | âœ… í†µê³¼   | ë‹¨ì¼ Partition ë‚´ FIFO ë³´ì¥        |
| **ë©±ë“±ì„±**           | âœ… í†µê³¼   | requestId ê¸°ë°˜ ì¤‘ë³µ ì²´í¬ í•„ìˆ˜      |
| **ëŒ€ê·œëª¨ ì²˜ë¦¬**      | âœ… í†µê³¼   | 100ê±´/614ms = 162 TPS              |

#### ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ì„¤ê³„ ê²€ì¦ ì™„ë£Œ

- âœ… **íŒŒí‹°ì…”ë‹ ì „ëµ**: couponId ê¸°ë°˜ í‚¤ë¡œ ìˆœì„œ ë³´ì¥
- âœ… **ë³‘ë ¬ ì²˜ë¦¬**: ë‹¤ì¤‘ íŒŒí‹°ì…˜/Consumerë¡œ ì²˜ë¦¬ëŸ‰ í™•ì¥
- âœ… **ë©±ë“±ì„±**: requestId ê¸°ë°˜ ì¤‘ë³µ ë°œê¸‰ ë°©ì§€
- âœ… **ì„ ì°©ìˆœ ë³´ì¥**: Kafka íŒŒí‹°ì…˜ ë‚´ ìˆœì„œ ë³´ì¥ í™œìš©

---

### 4.7.10 CLI ì‹¤ìŠµ: ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ í…ŒìŠ¤íŠ¸

JUnit í…ŒìŠ¤íŠ¸ì™€ ë™ì¼í•œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ CLIë¡œë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### í™˜ê²½ ì¤€ë¹„

```bash
# Docker Composeë¡œ Kafka í™˜ê²½ ì‹¤í–‰
docker-compose up -d

# ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
docker-compose ps
```

**ì‹¤í–‰ ê²°ê³¼:**
```
NAME                  IMAGE                             STATUS                    PORTS
ecommerce-kafka       confluentinc/cp-kafka:7.5.0       Up (healthy)              0.0.0.0:9092->9092/tcp
ecommerce-kafka-ui    provectuslabs/kafka-ui:latest     Up                        0.0.0.0:8090->8080/tcp
ecommerce-zookeeper   confluentinc/cp-zookeeper:7.5.0   Up (healthy)              0.0.0.0:2181->2181/tcp
```

---

#### CLI í…ŒìŠ¤íŠ¸ 1: í† í”½ ìƒì„± ë° íŒŒí‹°ì…”ë‹ í™•ì¸

```bash
# í† í”½ ìƒì„± (3ê°œ íŒŒí‹°ì…˜)
docker exec ecommerce-kafka kafka-topics --create \
  --bootstrap-server localhost:9092 \
  --topic coupon-issue-cli-test \
  --partitions 3 \
  --replication-factor 1
```

**ì‹¤í–‰ ê²°ê³¼:**
```
Created topic coupon-issue-cli-test.
```

```bash
# í† í”½ ìƒì„¸ ì •ë³´ í™•ì¸
docker exec ecommerce-kafka kafka-topics --describe \
  --bootstrap-server localhost:9092 \
  --topic coupon-issue-cli-test
```

**ì‹¤í–‰ ê²°ê³¼:**
```
Topic: coupon-issue-cli-test  PartitionCount: 3  ReplicationFactor: 1
    Topic: coupon-issue-cli-test  Partition: 0  Leader: 1  Replicas: 1  Isr: 1
    Topic: coupon-issue-cli-test  Partition: 1  Leader: 1  Replicas: 1  Isr: 1
    Topic: coupon-issue-cli-test  Partition: 2  Leader: 1  Replicas: 1  Isr: 1
```

---

#### CLI í…ŒìŠ¤íŠ¸ 2: ë™ì¼ Key â†’ ë™ì¼ íŒŒí‹°ì…˜ í™•ì¸

```bash
# couponId=1ë¡œ 5ê±´ ë°œí–‰ (Key ê¸°ë°˜ íŒŒí‹°ì…”ë‹)
echo "1:{\"requestId\":\"REQ-1\",\"couponId\":1,\"userId\":1}" | \
  docker exec -i ecommerce-kafka kafka-console-producer \
    --bootstrap-server localhost:9092 \
    --topic coupon-issue-cli-test \
    --property "parse.key=true" \
    --property "key.separator=:"

echo "1:{\"requestId\":\"REQ-2\",\"couponId\":1,\"userId\":2}" | \
  docker exec -i ecommerce-kafka kafka-console-producer \
    --bootstrap-server localhost:9092 \
    --topic coupon-issue-cli-test \
    --property "parse.key=true" \
    --property "key.separator=:"

# ... (userId 3, 4, 5ë„ ë™ì¼í•˜ê²Œ ë°œí–‰)
```

```bash
# ë©”ì‹œì§€ ìˆ˜ì‹  (íŒŒí‹°ì…˜ ì •ë³´ í¬í•¨)
docker exec ecommerce-kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic coupon-issue-cli-test \
  --from-beginning \
  --property print.key=true \
  --property print.partition=true \
  --property print.offset=true \
  --max-messages 5
```

**ì‹¤í–‰ ê²°ê³¼:**
```
Partition:0  Offset:0  1  {"requestId":"REQ-1","couponId":1,"userId":1}
Partition:0  Offset:1  1  {"requestId":"REQ-2","couponId":1,"userId":2}
Partition:0  Offset:2  1  {"requestId":"REQ-3","couponId":1,"userId":3}
Partition:0  Offset:3  1  {"requestId":"REQ-4","couponId":1,"userId":4}
Partition:0  Offset:4  1  {"requestId":"REQ-5","couponId":1,"userId":5}
```

> âœ… **ê²€ì¦**: ë™ì¼ Key(couponId=1)ì˜ ëª¨ë“  ë©”ì‹œì§€ê°€ **Partition 0**ìœ¼ë¡œ ë¼ìš°íŒ…ë¨

---

#### CLI í…ŒìŠ¤íŠ¸ 3: ë‹¤ë¥¸ Key â†’ íŒŒí‹°ì…˜ ë¶„ì‚° í™•ì¸

```bash
# ë‹¤ë¥¸ couponIdë¡œ ë©”ì‹œì§€ ë°œí–‰
echo "1:{\"couponId\":1}" | docker exec -i ecommerce-kafka kafka-console-producer --bootstrap-server localhost:9092 --topic coupon-issue-cli-test --property "parse.key=true" --property "key.separator=:"
echo "2:{\"couponId\":2}" | docker exec -i ecommerce-kafka kafka-console-producer --bootstrap-server localhost:9092 --topic coupon-issue-cli-test --property "parse.key=true" --property "key.separator=:"
echo "3:{\"couponId\":3}" | docker exec -i ecommerce-kafka kafka-console-producer --bootstrap-server localhost:9092 --topic coupon-issue-cli-test --property "parse.key=true" --property "key.separator=:"
# ... couponId 4~9ë„ ë™ì¼í•˜ê²Œ ë°œí–‰
```

**ì‹¤í–‰ ê²°ê³¼:**
```
Partition:0  1  {"couponId":1}
Partition:0  5  {"couponId":5}
Partition:0  7  {"couponId":7}
Partition:0  8  {"couponId":8}
Partition:1  4  {"couponId":4}
Partition:1  6  {"couponId":6}
Partition:2  2  {"couponId":2}
Partition:2  3  {"couponId":3}
Partition:2  9  {"couponId":9}
```

**íŒŒí‹°ì…˜ë³„ ë¶„í¬:**
| íŒŒí‹°ì…˜      | couponId (Key) |
|-------------|----------------|
| Partition 0 | 1, 5, 7, 8     |
| Partition 1 | 4, 6           |
| Partition 2 | 2, 3, 9        |

> âœ… **ê²€ì¦**: ë‹¤ë¥¸ KeyëŠ” í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ì— ë”°ë¼ ì—¬ëŸ¬ íŒŒí‹°ì…˜ì— ë¶„ì‚°ë¨

---

#### CLI í…ŒìŠ¤íŠ¸ 4: Consumer Group ë° Offset ê´€ë¦¬

```bash
# Consumer Groupìœ¼ë¡œ ë©”ì‹œì§€ ì†Œë¹„
docker exec ecommerce-kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic coupon-issue-cli-test \
  --from-beginning \
  --group coupon-issue-group \
  --property print.key=true \
  --property print.partition=true \
  --max-messages 6
```

**ì‹¤í–‰ ê²°ê³¼:**
```
Partition:0  1  {"requestId":"G-1","couponId":1,"userId":1}
Partition:0  1  {"requestId":"G-4","couponId":1,"userId":4}
Partition:2  2  {"requestId":"G-2","couponId":2,"userId":2}
Partition:2  3  {"requestId":"G-3","couponId":3,"userId":3}
...
```

```bash
# Consumer Group ìƒíƒœ í™•ì¸
docker exec ecommerce-kafka kafka-consumer-groups \
  --bootstrap-server localhost:9092 \
  --group coupon-issue-group \
  --describe
```

**ì‹¤í–‰ ê²°ê³¼:**
```
GROUP              TOPIC                      PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG
coupon-issue-group coupon-issue-cli-test      0          2               2               0
coupon-issue-group coupon-issue-cli-test      1          0               0               0
coupon-issue-group coupon-issue-cli-test      2          4               4               0
```

> âœ… **ê²€ì¦**: ëª¨ë“  íŒŒí‹°ì…˜ LAG=0 (ì •ìƒ ì²˜ë¦¬ ì™„ë£Œ), íŒŒí‹°ì…˜ ë‚´ ìˆœì„œ ë³´ì¥ë¨

---

#### CLI í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½

- âœ… **í…ŒìŠ¤íŠ¸ 1: ë™ì¼ Key íŒŒí‹°ì…”ë‹**
  - couponId=1 â†’ ëª¨ë“  ë©”ì‹œì§€ê°€ Partition 0ë¡œ ë¼ìš°íŒ…

- âœ… **í…ŒìŠ¤íŠ¸ 2: ë‹¤ë¥¸ Key íŒŒí‹°ì…˜ ë¶„ì‚°**
  - Partition 0: couponId 1, 5, 7, 8
  - Partition 1: couponId 4, 6
  - Partition 2: couponId 2, 3, 9

- âœ… **í…ŒìŠ¤íŠ¸ 3: íŒŒí‹°ì…˜ ë‚´ ìˆœì„œ ë³´ì¥**
  - Partition 0: G-1(userId:1) â†’ G-4(userId:4) ìˆœì„œ ë³´ì¥
  - Partition 2: G-2 â†’ G-3 â†’ G-5 â†’ G-6 ìˆœì„œ ë³´ì¥

- âœ… **í…ŒìŠ¤íŠ¸ 4: Consumer Group Offset ê´€ë¦¬**
  - ëª¨ë“  íŒŒí‹°ì…˜ LAG=0 (ì •ìƒ ì²˜ë¦¬ ì™„ë£Œ)

---

#### JUnit vs CLI í…ŒìŠ¤íŠ¸ ë¹„êµ

| í…ŒìŠ¤íŠ¸ í•­ëª©                 | JUnit ê²°ê³¼                | CLI ê²°ê³¼               |
|-----------------------------|---------------------------|------------------------|
| ë™ì¼ Key â†’ ë™ì¼ Partition   | âœ… ë™ì¼ íŒŒí‹°ì…˜ ë¼ìš°íŒ…     | âœ… ë™ì¼ íŒŒí‹°ì…˜ ë¼ìš°íŒ…  |
| íŒŒí‹°ì…˜ ë‚´ ìˆœì„œ ë³´ì¥         | âœ… FIFO ë³´ì¥              | âœ… FIFO ë³´ì¥           |
| Consumer Group Offset       | âœ… ì²˜ë¦¬ ì™„ë£Œ              | âœ… LAG=0               |
| íŒŒí‹°ì…˜ ë¶„ì‚°                 | âœ… 3ê°œ íŒŒí‹°ì…˜             | âœ… 3ê°œ íŒŒí‹°ì…˜          |

> **ì°¸ê³ **: JUnitê³¼ CLI í…ŒìŠ¤íŠ¸ëŠ” ì„œë¡œ ë‹¤ë¥¸ í† í”½ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, ë™ì¼ Keyë¼ë„ í• ë‹¹ë˜ëŠ” íŒŒí‹°ì…˜ ë²ˆí˜¸ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ê²ƒì€ **ë™ì¼ Keyê°€ í•­ìƒ ë™ì¼ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¼ìš°íŒ…ëœë‹¤ëŠ” ì¼ê´€ì„±**ì…ë‹ˆë‹¤.

> ğŸ“Œ **Kafka UI**: http://localhost:8090 ì—ì„œ í† í”½, ë©”ì‹œì§€, Consumer Group ìƒíƒœë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.